# Executable Specification Template
# This file defines behavior scenarios that can be executed as tests
# Format: YAML with Given/When/Then structure inspired by Gherkin

version: "1.0"
feature_id: "{{FEATURE_ID}}"
feature_name: "{{FEATURE_NAME}}"
generated_at: "{{GENERATED_TIMESTAMP}}"

# Scenarios define executable test cases from user story acceptance criteria
# Each scenario can be generated into Jest, Cucumber, or Pytest format
scenarios:
  - scenario_id: "S001"
    name: "User signup with valid credentials"
    description: "Verify that a new user can successfully sign up with valid email and password"
    story_mapping: "Story 001"
    acceptance_criteria: "User can sign up with email and password"

    # Given: Pre-conditions and context setup
    given:
      - step_id: "G001"
        description: "the database is empty"
        setup:
          - action: "truncate_table"
            target: "users"
      - step_id: "G002"
        description: "the email service is configured"
        setup:
          - action: "mock_service"
            target: "email_service"

    # When: Actions and events
    when:
      - step_id: "W001"
        description: "POST /api/users with valid credentials"
        action:
          method: "POST"
          endpoint: "/api/users"
          headers:
            Content-Type: "application/json"
          body:
            email: "test@example.com"
            password: "SecurePass123!"
            confirm_password: "SecurePass123!"

    # Then: Expected outcomes and validations
    then:
      - step_id: "T001"
        description: "response status is 201"
        assertion:
          type: "status_code"
          expected: 201
          comparison: "equals"

      - step_id: "T002"
        description: "response contains user id"
        assertion:
          type: "json_path"
          path: "$.id"
          expected: "exists"
          comparison: "exists"

      - step_id: "T003"
        description: "response email matches input"
        assertion:
          type: "json_path"
          path: "$.email"
          expected: "test@example.com"
          comparison: "equals"

      - step_id: "T004"
        description: "database contains 1 user"
        assertion:
          type: "database_query"
          query: "SELECT COUNT(*) FROM users"
          expected: "1"
          comparison: "equals"

      - step_id: "T005"
        description: "password is hashed in database"
        assertion:
          type: "database_query"
          query: "SELECT password_hash FROM users WHERE email = 'test@example.com'"
          expected: "not_plain_text"
          comparison: "not_equals"

      - step_id: "T006"
        description: "welcome email was sent"
        assertion:
          type: "service_mock"
          service: "email_service"
          method: "send"
          expected_calls: 1
          with:
            to: "test@example.com"
            subject: "Welcome"

    # Test generation hints
    test_generation:
      frameworks: ["jest", "cucumber", "pytest"]
      priority: "critical"
      tags: ["authentication", "signup", "happy-path"]

  - scenario_id: "S002"
    name: "User signup with invalid email"
    description: "Verify that signup fails with invalid email format"
    story_mapping: "Story 001"
    acceptance_criteria: "User cannot sign up with invalid email"

    given:
      - step_id: "G001"
        description: "the database is empty"
        setup:
          - action: "truncate_table"
            target: "users"

    when:
      - step_id: "W001"
        description: "POST /api/users with invalid email"
        action:
          method: "POST"
          endpoint: "/api/users"
          headers:
            Content-Type: "application/json"
          body:
            email: "invalid-email"
            password: "SecurePass123!"

    then:
      - step_id: "T001"
        description: "response status is 400"
        assertion:
          type: "status_code"
          expected: 400
          comparison: "equals"

      - step_id: "T002"
        description: "response contains error message"
        assertion:
          type: "json_path"
          path: "$.error"
          expected: "exists"
          comparison: "exists"

      - step_id: "T003"
        description: "database contains 0 users"
        assertion:
          type: "database_query"
          query: "SELECT COUNT(*) FROM users"
          expected: "0"
          comparison: "equals"

    test_generation:
      frameworks: ["jest", "cucumber", "pytest"]
      priority: "high"
      tags: ["authentication", "signup", "validation"]

  - scenario_id: "S003"
    name: "User login with valid credentials"
    description: "Verify that an existing user can log in with correct credentials"
    story_mapping: "Story 002"
    acceptance_criteria: "User can log in with email and password"

    given:
      - step_id: "G001"
        description: "a registered user exists"
        setup:
          - action: "seed_database"
            target: "users"
            data:
              email: "existing@example.com"
              password: "$2a$10$hashedpassword"
              verified: true

    when:
      - step_id: "W001"
        description: "POST /api/auth/login with valid credentials"
        action:
          method: "POST"
          endpoint: "/api/auth/login"
          headers:
            Content-Type: "application/json"
          body:
            email: "existing@example.com"
            password: "PlainTextPassword123!"

    then:
      - step_id: "T001"
        description: "response status is 200"
        assertion:
          type: "status_code"
          expected: 200
          comparison: "equals"

      - step_id: "T002"
        description: "response contains authentication token"
        assertion:
          type: "json_path"
          path: "$.token"
          expected: "exists"
          comparison: "exists"

      - step_id: "T003"
        description: "response contains user data"
        assertion:
          type: "json_path"
          path: "$.user.email"
          expected: "existing@example.com"
          comparison: "equals"

    test_generation:
      frameworks: ["jest", "cucumber", "pytest"]
      priority: "critical"
      tags: ["authentication", "login", "happy-path"]

# Contract tests verify API contracts (request/response schemas)
contract_tests:
  - contract_id: "C001"
    name: "POST /api/users contract"
    description: "Verify request and response schema compliance"

    request_schema:
      type: "object"
      required: ["email", "password"]
      properties:
        email:
          type: "string"
          format: "email"
        password:
          type: "string"
          minLength: 8
        confirm_password:
          type: "string"

    response_schema_success:
      type: "object"
      properties:
        id:
          type: "string"
          format: "uuid"
        email:
          type: "string"
          format: "email"
        created_at:
          type: "string"
          format: "date-time"

    response_schema_error:
      type: "object"
      properties:
        error:
          type: "string"
        message:
          type: "string"

# State machine definitions for complex workflows
state_machines:
  - machine_id: "SM001"
    name: "User Account State Machine"
    description: "States and transitions for user account lifecycle"

    initial_state: "pending"

    states:
      - state_id: "pending"
        name: "Pending Verification"
        on_entry:
          - send_verification_email
        transitions:
          - event: "verify_email"
            target: "verified"
            guard: "token_is_valid"
          - event: "timeout"
            target: "expired"
            after: "24h"

      - state_id: "verified"
        name: "Verified"
        transitions:
          - event: "complete_profile"
            target: "active"
          - event: "timeout"
            target: "expired"
            after: "7d"

      - state_id: "active"
        name: "Active"
        transitions:
          - event: "suspend"
            target: "suspended"
            guard: "admin_permission"

      - state_id: "suspended"
        name: "Suspended"
        transitions:
          - event: "reactivate"
            target: "active"
            guard: "admin_permission"

      - state_id: "expired"
        name: "Expired"
        final: true

# Decision tables for business rules
decision_tables:
  - table_id: "DT001"
    name: "Storage Allocation Decision Table"
    description: "Determine storage allocation based on user tier and age"

    inputs:
      - field: "user_tier"
        values: ["free", "premium", "enterprise"]
      - field: "age"
        values: ["<18", ">=18"]
      - field: "parental_consent"
        values: [true, false]

    rules:
      - conditions:
          user_tier: "free"
          age: "<18"
          parental_consent: true
        actions:
          storage_gb: 5
          require_consent: true
          block: false

      - conditions:
          user_tier: "free"
          age: "<18"
          parental_consent: false
        actions:
          storage_gb: 0
          require_consent: true
          block: true

      - conditions:
          user_tier: "free"
          age: ">=18"
        actions:
          storage_gb: 5
          require_consent: false
          block: false

      - conditions:
          user_tier: "premium"
          age: "<18"
          parental_consent: true
        actions:
          storage_gb: 100
          require_consent: true
          block: false

      - conditions:
          user_tier: "premium"
          age: ">=18"
        actions:
          storage_gb: 100
          require_consent: false
          block: false

      - conditions:
          user_tier: "enterprise"
        actions:
          storage_gb: 1000
          require_consent: false
          block: false

# Metadata for test generation
test_generation_config:
  default_framework: "jest"
  output_directory: "tests/"
  coverage_target: 100
  generate_hooks: true
  generate_mocks: true
  include_edge_cases: true
